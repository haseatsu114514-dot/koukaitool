<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>生年月日逆算くん | 年齢×誕生日で逆算</title>
  <meta name="description" content="占い師さんや占い好きの人向け、「年齢」と「誕生日」だけ分かる相手の生年月日を逆算できるツール。">
  <style>
    :root {
      --bg1: #f6fbf8;
      --bg2: #fcfefd;
      --card: #ffffff;
      --line: #d8e4dc;
      --text: #1d2d24;
      --muted: #678274;
      --brand: #4f8b70;
      --brand-deep: #3f725c;
      --accent: #edf6f0;
      --ok: #2f7c57;
      --danger: #ad1f35;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Hiragino Sans", "Yu Gothic", sans-serif;
      background:
        radial-gradient(circle at 6% 8%, #e9f5ed 0%, transparent 38%),
        radial-gradient(circle at 88% 12%, #f1faf4 0%, transparent 34%),
        linear-gradient(140deg, var(--bg1), var(--bg2));
    }

    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 24px 16px 40px;
      display: grid;
      gap: 14px;
    }

    .hero {
      background: linear-gradient(130deg, #5f9078, #79ab92);
      color: #f4f9ff;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 14px 30px rgba(53, 91, 71, 0.2);
    }

    .hero h1 {
      margin: 0;
      font-size: 1.85rem;
      letter-spacing: 0.01em;
    }

    .hero p {
      margin: 8px 0 0;
      color: rgba(244, 249, 255, 0.88);
      line-height: 1.55;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 22px rgba(62, 98, 77, 0.06);
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 1.08rem;
    }

    #todayText {
      margin: 0;
      color: var(--muted);
      font-size: 0.93rem;
    }

    label {
      display: block;
      color: var(--muted);
      font-size: 0.88rem;
      margin-bottom: 4px;
    }

    input {
      width: 100%;
      border: 1px solid #cfddd4;
      border-radius: 9px;
      padding: 8px 10px;
      font-size: 1rem;
      background: #fff;
      color: var(--text);
    }

    input.input-error {
      border-color: #d25b6c;
      background: #fff7f8;
    }

    .input-hint {
      margin: 6px 0 0;
      font-size: 0.78rem;
      color: var(--danger);
      min-height: 1.1em;
    }

    .people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .person-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #fbfdff;
    }

    .person-card h3 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .birthday-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .person-result {
      margin-top: 6px;
      border-radius: 8px;
      background: var(--accent);
      min-height: 38px;
      padding: 8px 10px;
      line-height: 1.45;
      font-size: 0.9rem;
      white-space: pre-line;
    }

    .person-result.error {
      background: #ffecef;
      color: var(--danger);
    }

    .person-toggle-wrap {
      margin-top: 10px;
    }

    .toggle-person-btn {
      border: 1px solid #caddcf;
      background: #f1f6f3;
      color: var(--text);
      font-size: 0.86rem;
      padding: 7px 10px;
    }

    .person-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
    }

    .copy-person-btn {
      border: 1px solid #d5e0da;
      background: #f1f5f2;
      color: var(--text);
      font-size: 0.82rem;
      padding: 6px 10px;
    }

    .copy-person-btn:disabled {
      opacity: 0.52;
      cursor: default;
    }

    .result-row {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
    }

    .result-name {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .result-date {
      font-weight: 700;
      font-size: 1.08rem;
      color: #2f7257;
      letter-spacing: 0.01em;
    }

    .result-note {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .result-note-inline {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .result-candidates {
      margin-top: 7px;
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    .candidate-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid #c9ddce;
      background: #f4faf6;
      padding: 5px 9px;
      font-size: 0.78rem;
      color: #335b47;
    }

    .candidate-date {
      font-weight: 700;
      color: #2f7257;
    }

    .is-hidden {
      display: none;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      border: none;
      border-radius: 9px;
      padding: 9px 13px;
      cursor: pointer;
      font-size: 0.94rem;
    }

    #calcBtn {
      background: var(--brand);
      color: #fff;
    }

    #calcBtn:hover {
      background: var(--brand-deep);
    }

    #calcBtn:disabled {
      background: #93b4a2;
      cursor: default;
    }

    #clearBtn,
    #copyBtn {
      border: 1px solid #d5e0da;
      background: #f1f5f2;
      color: var(--text);
    }

    .summary-result {
      margin-top: 12px;
      border-radius: 10px;
      background: var(--accent);
      padding: 12px;
      min-height: 48px;
      line-height: 1.55;
      white-space: pre-line;
    }

    .summary-result.error {
      background: #ffecef;
      color: var(--danger);
    }

    .status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--muted);
      min-height: 1.2em;
    }

    .status.ok {
      color: var(--ok);
    }

    .provider-panel {
      border: none;
      padding: 0;
      overflow: hidden;
    }

    .provider-banner {
      position: relative;
      display: block;
      text-decoration: none;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #2d4a3a;
      box-shadow: 0 12px 24px rgba(36, 62, 48, 0.2);
    }

    .provider-banner img {
      display: block;
      width: 100%;
      height: 182px;
      object-fit: cover;
      object-position: center;
      transition: transform 0.25s ease;
    }

    .provider-banner:hover img {
      transform: scale(1.02);
    }

    .provider-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        92deg,
        rgba(18, 43, 29, 0.65) 0%,
        rgba(18, 43, 29, 0.5) 46%,
        rgba(18, 43, 29, 0.32) 72%,
        rgba(18, 43, 29, 0.2) 100%
      );
    }

    .provider-content {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      padding: 16px 18px;
      color: #f8fbff;
      z-index: 1;
    }

    .provider-label {
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: rgba(248, 251, 255, 0.82);
    }

    .provider-title {
      font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      line-height: 1.15;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
    }

    .provider-sub {
      font-size: 0.85rem;
      color: rgba(248, 251, 255, 0.9);
    }
  </style>
</head>
<body>
  <main>
    <section class="hero">
      <h1>生年月日逆算くん</h1>
      <p>占い師さんや占い好きの人向け、「年齢」と「誕生日」だけ分かる相手の生年月日を逆算できるツール。</p>
    </section>

    <section class="panel">
      <h2>年齢×誕生日 逆算（2人まで）</h2>
      <p id="todayText"></p>

      <div class="people-grid">
        <article id="personCard1" class="person-card">
          <h3>1人目（必須）</h3>
          <label for="name1">名前（任意）</label>
          <input id="name1" type="text" placeholder="例: 相談相手A">

          <label for="age1">今の年齢</label>
          <input id="age1" type="number" min="0" max="130" placeholder="例: 28">

          <label>誕生日（月 / 日）</label>
          <div class="birthday-row">
            <input id="month1" type="number" min="1" max="12" placeholder="月">
            <input id="day1" type="number" min="1" max="31" placeholder="日">
          </div>
          <p id="inputHint1" class="input-hint"></p>

          <div id="personResult1" class="person-result">未計算</div>
          <div class="person-actions">
            <button id="copyPerson1Btn" class="copy-person-btn" type="button" disabled>1人目をコピー</button>
          </div>
        </article>
      </div>

      <div class="person-toggle-wrap">
        <button id="togglePerson2Btn" class="toggle-person-btn" type="button" aria-expanded="false">+ 2人目を追加</button>
      </div>

      <div class="people-grid">
        <article id="personCard2" class="person-card is-hidden">
          <h3>2人目</h3>
          <label for="name2">名前（任意）</label>
          <input id="name2" type="text" placeholder="例: 相談相手B">

          <label for="age2">今の年齢</label>
          <input id="age2" type="number" min="0" max="130" placeholder="例: 35">

          <label>誕生日（月 / 日）</label>
          <div class="birthday-row">
            <input id="month2" type="number" min="1" max="12" placeholder="月">
            <input id="day2" type="number" min="1" max="31" placeholder="日">
          </div>
          <p id="inputHint2" class="input-hint"></p>

          <div id="personResult2" class="person-result">未入力</div>
          <div class="person-actions">
            <button id="copyPerson2Btn" class="copy-person-btn" type="button" disabled>2人目をコピー</button>
          </div>
        </article>
      </div>

      <div class="actions">
        <button id="calcBtn" type="button">生年月日を逆算する</button>
        <button id="copyBtn" type="button">結果をコピー</button>
        <button id="clearBtn" type="button">入力クリア</button>
      </div>

      <div id="summaryResult" class="summary-result">未計算</div>
      <p id="statusText" class="status"></p>
    </section>

    <section class="panel provider-panel">
      <a
        class="provider-banner"
        href="https://uranai-rokkon.com/"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img src="assets/rokkon-provider.jpg" alt="占い処 六根清浄">
        <span class="provider-overlay"></span>
        <span class="provider-content">
          <span class="provider-label">提供元</span>
          <span class="provider-title">占い処 六根清浄</span>
          <span class="provider-sub">https://uranai-rokkon.com/</span>
        </span>
      </a>
    </section>
  </main>

  <script>
    const calcBtn = document.getElementById("calcBtn");
    const todayText = document.getElementById("todayText");
    const summaryResult = document.getElementById("summaryResult");
    const statusText = document.getElementById("statusText");
    const personCard2 = document.getElementById("personCard2");
    const togglePerson2Btn = document.getElementById("togglePerson2Btn");

    const personResultMap = {
      1: document.getElementById("personResult1"),
      2: document.getElementById("personResult2")
    };

    const copyPersonBtnMap = {
      1: document.getElementById("copyPerson1Btn"),
      2: document.getElementById("copyPerson2Btn")
    };

    const inputHintMap = {
      1: document.getElementById("inputHint1"),
      2: document.getElementById("inputHint2")
    };

    const latestPersonResultText = {
      1: "",
      2: ""
    };

    let latestResultText = "";
    let currentDateKey = "";
    let isPerson2Visible = false;

    setPerson2Visibility(false);
    setPersonCopyState(1, "");
    setPersonCopyState(2, "");
    clearPersonInputValidation(1);
    clearPersonInputValidation(2);
    refreshCurrentDate(true);
    installRealtimeValidation();
    applyRealtimeValidationForPerson(1);
    updateCalcButtonState();

    calcBtn.addEventListener("click", calculateBirthDate);
    document.getElementById("copyBtn").addEventListener("click", copyResult);
    document.getElementById("clearBtn").addEventListener("click", clearInputs);
    togglePerson2Btn.addEventListener("click", togglePerson2Card);
    copyPersonBtnMap[1].addEventListener("click", () => copyPersonResult(1));
    copyPersonBtnMap[2].addEventListener("click", () => copyPersonResult(2));

    window.addEventListener("focus", () => {
      refreshCurrentDate(false);
    });
    setInterval(() => {
      refreshCurrentDate(false);
    }, 60000);

    function calculateBirthDate() {
      const today = refreshCurrentDate(false);
      const summaryLines = [];
      const peopleToCheck = isPerson2Visible ? [1, 2] : [1];

      let successCount = 0;
      let firstPersonValid = false;

      for (let idx = 0; idx < peopleToCheck.length; idx += 1) {
        const i = peopleToCheck[idx];
        const isFirstPerson = i === 1;
        const name = getValue("name" + i);
        const ageRaw = getValue("age" + i);
        const monthRaw = getValue("month" + i);
        const dayRaw = getValue("day" + i);
        const cardResult = personResultMap[i];

        if (!name && !ageRaw && !monthRaw && !dayRaw) {
          if (isFirstPerson) {
            setCardError(cardResult, "1人目は必須です。年齢と誕生日（月/日）を入力してください。");
            setPersonCopyState(i, "");
            continue;
          }
          setCardMessage(cardResult, "未入力");
          setPersonCopyState(i, "");
          continue;
        }

        if (!ageRaw || !monthRaw || !dayRaw) {
          if (isFirstPerson) {
            setCardError(cardResult, "1人目は必須です。年齢と誕生日（月/日）をすべて入力してください。");
            setPersonCopyState(i, "");
            continue;
          }
          setCardError(cardResult, "年齢と誕生日（月/日）をすべて入力してください。");
          setPersonCopyState(i, "");
          continue;
        }

        const age = Number(ageRaw);
        const month = Number(monthRaw);
        const day = Number(dayRaw);

        if (!Number.isInteger(age) || age < 0 || age > 130) {
          setCardError(cardResult, "年齢を0〜130で入力してください。");
          setPersonCopyState(i, "");
          continue;
        }

        if (!isValidMonthDayInput(month, day)) {
          setCardError(cardResult, "誕生日（月/日）が正しくありません。");
          setPersonCopyState(i, "");
          continue;
        }

        const resolved = resolveBirthDate(age, month, day, today);
        if (!resolved.success) {
          setCardError(cardResult, "入力条件から生年月日を確定できません。");
          setPersonCopyState(i, "");
          continue;
        }

        const label = name || i + "人目";
        const resolvedText = formatResolvedPlainText(resolved);
        const personText = label + ": " + resolvedText;

        renderPersonResult(cardResult, label, resolved);
        summaryLines.push(personText);
        setPersonCopyState(i, personText);

        successCount += 1;
        if (isFirstPerson) {
          firstPersonValid = true;
        }
      }

      if (!isPerson2Visible) {
        setCardMessage(personResultMap[2], "未入力");
        setPersonCopyState(2, "");
      }

      if (!firstPersonValid) {
        setSummaryError("1人目の入力を確認してください。");
        return;
      }

      if (successCount === 0) {
        setSummaryError("入力エラーがあります。各欄を確認してください。");
        return;
      }

      const summaryText = summaryLines.join("\n");
      summaryResult.textContent = summaryText;
      summaryResult.classList.remove("error");
      latestResultText = summaryText;
      setStatus("逆算しました。", true);
    }

    function resolveBirthDate(age, birthMonth, birthDay, today) {
      if (birthMonth !== 2 || birthDay !== 29) {
        const year = findBirthYear(age, birthMonth, birthDay, today, "feb28");
        if (year == null) {
          return { success: false };
        }
        return {
          success: true,
          kind: "single",
          date: formatDate(year, birthMonth, birthDay),
          note: ""
        };
      }

      const yearFeb = findBirthYear(age, 2, 29, today, "feb28");
      const yearMar = findBirthYear(age, 2, 29, today, "mar1");

      if (yearFeb == null && yearMar == null) {
        return { success: false };
      }

      if (yearFeb != null && yearMar != null) {
        if (yearFeb === yearMar) {
          return {
            success: true,
            kind: "single",
            date: formatDate(yearFeb, 2, 29),
            note: "2/29生まれ対応"
          };
        }
        return {
          success: true,
          kind: "candidates",
          options: [
            { date: formatDate(yearFeb, 2, 29), note: "2/28基準" },
            { date: formatDate(yearMar, 2, 29), note: "3/1基準" }
          ]
        };
      }

      if (yearFeb != null) {
        return {
          success: true,
          kind: "single",
          date: formatDate(yearFeb, 2, 29),
          note: "2/28基準"
        };
      }

      return {
        success: true,
        kind: "single",
        date: formatDate(yearMar, 2, 29),
        note: "3/1基準"
      };
    }

    function formatResolvedPlainText(resolved) {
      if (resolved.kind === "single") {
        if (!resolved.note) {
          return resolved.date;
        }
        return resolved.date + "（" + resolved.note + "）";
      }
      const candidateText = [];
      for (let i = 0; i < resolved.options.length; i += 1) {
        const option = resolved.options[i];
        candidateText.push(option.date + "（" + option.note + "）");
      }
      return "候補: " + candidateText.join(" / ");
    }

    function renderPersonResult(element, label, resolved) {
      const safeLabel = escapeHtml(label);

      if (resolved.kind === "single") {
        const noteHtml = resolved.note
          ? '<div class="result-note">（' + escapeHtml(resolved.note) + "）</div>"
          : "";
        element.innerHTML =
          '<div class="result-row">' +
          '<span class="result-name">' + safeLabel + "</span>" +
          '<span class="result-date">' + escapeHtml(resolved.date) + "</span>" +
          "</div>" +
          noteHtml;
      } else {
        let badgesHtml = "";
        for (let i = 0; i < resolved.options.length; i += 1) {
          const option = resolved.options[i];
          badgesHtml +=
            '<span class="candidate-badge">' +
            '<span class="candidate-date">' + escapeHtml(option.date) + "</span>" +
            '<span class="candidate-note">' + escapeHtml(option.note) + "</span>" +
            "</span>";
        }
        element.innerHTML =
          '<div class="result-row">' +
          '<span class="result-name">' + safeLabel + "</span>" +
          '<span class="result-note-inline">2/29の平年判定で候補が分かれます</span>' +
          "</div>" +
          '<div class="result-candidates">' + badgesHtml + "</div>";
      }

      element.classList.remove("error");
    }

    function togglePerson2Card() {
      if (isPerson2Visible) {
        clearPersonInputs(2);
        setCardMessage(personResultMap[2], "未入力");
        clearPersonInputValidation(2);
        setPersonCopyState(2, "");
        setPerson2Visibility(false);
        resetSummaryResult();
        setStatus("", false);
        updateCalcButtonState();
        return;
      }

      setPerson2Visibility(true);
      setCardMessage(personResultMap[2], "未計算");
      clearPersonInputValidation(2);
      setPersonCopyState(2, "");
      resetSummaryResult();
      setStatus("", false);
      updateCalcButtonState();
    }

    function setPerson2Visibility(visible) {
      isPerson2Visible = visible;
      personCard2.classList.toggle("is-hidden", !visible);
      togglePerson2Btn.textContent = visible ? "− 2人目を閉じる" : "+ 2人目を追加";
      togglePerson2Btn.setAttribute("aria-expanded", visible ? "true" : "false");
    }

    function installRealtimeValidation() {
      const fieldMap = {
        1: ["age1", "month1", "day1"],
        2: ["age2", "month2", "day2"]
      };

      const people = [1, 2];
      for (let i = 0; i < people.length; i += 1) {
        const personIndex = people[i];
        const fieldIds = fieldMap[personIndex];
        for (let j = 0; j < fieldIds.length; j += 1) {
          const fieldId = fieldIds[j];
          document.getElementById(fieldId).addEventListener("input", () => {
            applyRealtimeValidationForPerson(personIndex);
            updateCalcButtonState();
          });
        }
      }
    }

    function applyRealtimeValidationForPerson(index) {
      if (index === 2 && !isPerson2Visible) {
        clearPersonInputValidation(2);
        return;
      }

      const ageInput = document.getElementById("age" + index);
      const monthInput = document.getElementById("month" + index);
      const dayInput = document.getElementById("day" + index);

      const ageRaw = ageInput.value.trim();
      const monthRaw = monthInput.value.trim();
      const dayRaw = dayInput.value.trim();

      let message = "";
      let ageError = false;
      let monthError = false;
      let dayError = false;

      if (ageRaw !== "") {
        const age = Number(ageRaw);
        if (!Number.isInteger(age) || age < 0 || age > 130) {
          ageError = true;
          message = "年齢は0〜130で入力してください。";
        }
      }

      const hasMonth = monthRaw !== "";
      const hasDay = dayRaw !== "";
      if (hasMonth || hasDay) {
        if (!hasMonth || !hasDay) {
          monthError = !hasMonth;
          dayError = !hasDay;
          if (!message) {
            message = "誕生日は月日をセットで入力してください。";
          }
        } else {
          const month = Number(monthRaw);
          const day = Number(dayRaw);
          if (!isValidMonthDayInput(month, day)) {
            monthError = true;
            dayError = true;
            if (!message) {
              message = "誕生日（月/日）が正しくありません。";
            }
          }
        }
      }

      setInputErrorState(ageInput, ageError);
      setInputErrorState(monthInput, monthError);
      setInputErrorState(dayInput, dayError);
      setInputHint(index, message);
    }

    function updateCalcButtonState() {
      const ageRaw = getValue("age1");
      const monthRaw = getValue("month1");
      const dayRaw = getValue("day1");

      let canCalculate = false;
      if (ageRaw && monthRaw && dayRaw) {
        const age = Number(ageRaw);
        const month = Number(monthRaw);
        const day = Number(dayRaw);
        canCalculate =
          Number.isInteger(age) &&
          age >= 0 &&
          age <= 130 &&
          isValidMonthDayInput(month, day);
      }
      calcBtn.disabled = !canCalculate;
    }

    function findBirthYear(age, birthMonth, birthDay, today, leapMode) {
      const base = today.year - age;
      const candidates = [];
      for (let delta = -2; delta <= 2; delta += 1) {
        candidates.push(base + delta);
      }

      for (let i = 0; i < candidates.length; i += 1) {
        const year = candidates[i];
        if (!isRealBirthDate(year, birthMonth, birthDay)) {
          continue;
        }
        const calculatedAge = calculateAgeAtToday(year, birthMonth, birthDay, today, leapMode);
        if (calculatedAge === age) {
          return year;
        }
      }
      return null;
    }

    function calculateAgeAtToday(birthYear, birthMonth, birthDay, today, leapMode) {
      let age = today.year - birthYear;
      const anniversary = anniversaryInYear(today.year, birthMonth, birthDay, leapMode);
      const beforeBirthday =
        today.month < anniversary.month ||
        (today.month === anniversary.month && today.day < anniversary.day);
      if (beforeBirthday) {
        age -= 1;
      }
      return age;
    }

    function anniversaryInYear(year, birthMonth, birthDay, leapMode) {
      if (birthMonth === 2 && birthDay === 29 && !isLeapYear(year)) {
        if (leapMode === "mar1") {
          return { month: 3, day: 1 };
        }
        return { month: 2, day: 28 };
      }
      return { month: birthMonth, day: birthDay };
    }

    function isValidMonthDayInput(month, day) {
      if (!Number.isInteger(month) || !Number.isInteger(day)) {
        return false;
      }
      if (month < 1 || month > 12 || day < 1) {
        return false;
      }
      return isRealBirthDate(2000, month, day);
    }

    function isRealBirthDate(year, month, day) {
      const date = new Date(year, month - 1, day);
      return (
        date.getFullYear() === year &&
        date.getMonth() === month - 1 &&
        date.getDate() === day
      );
    }

    function isLeapYear(year) {
      if (year % 400 === 0) {
        return true;
      }
      if (year % 100 === 0) {
        return false;
      }
      return year % 4 === 0;
    }

    function getCurrentDateParts() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      const day = now.getDate();
      return {
        year: year,
        month: month,
        day: day,
        dateKey: formatDate(year, month, day)
      };
    }

    function refreshCurrentDate(force) {
      const current = getCurrentDateParts();
      if (force || current.dateKey !== currentDateKey) {
        currentDateKey = current.dateKey;
        todayText.textContent = "基準日: " + current.dateKey;
      }
      return current;
    }

    function clearInputs() {
      clearPersonInputs(1);
      clearPersonInputs(2);

      setCardMessage(personResultMap[1], "未計算");
      setCardMessage(personResultMap[2], "未入力");
      clearPersonInputValidation(1);
      clearPersonInputValidation(2);
      setPersonCopyState(1, "");
      setPersonCopyState(2, "");
      setPerson2Visibility(false);

      resetSummaryResult();
      setStatus("", false);
      updateCalcButtonState();
    }

    function clearPersonInputs(index) {
      document.getElementById("name" + index).value = "";
      document.getElementById("age" + index).value = "";
      document.getElementById("month" + index).value = "";
      document.getElementById("day" + index).value = "";
    }

    function clearPersonInputValidation(index) {
      const ageInput = document.getElementById("age" + index);
      const monthInput = document.getElementById("month" + index);
      const dayInput = document.getElementById("day" + index);
      setInputErrorState(ageInput, false);
      setInputErrorState(monthInput, false);
      setInputErrorState(dayInput, false);
      setInputHint(index, "");
    }

    function setInputErrorState(element, hasError) {
      element.classList.toggle("input-error", Boolean(hasError));
    }

    function setInputHint(index, message) {
      inputHintMap[index].textContent = message;
    }

    function setPersonCopyState(index, text) {
      latestPersonResultText[index] = text;
      copyPersonBtnMap[index].disabled = text === "";
    }

    function setCardMessage(element, message) {
      element.textContent = message;
      element.classList.remove("error");
    }

    function setCardError(element, message) {
      element.textContent = message;
      element.classList.add("error");
    }

    function resetSummaryResult() {
      summaryResult.textContent = "未計算";
      summaryResult.classList.remove("error");
      latestResultText = "";
    }

    function setSummaryError(message) {
      summaryResult.textContent = message;
      summaryResult.classList.add("error");
      latestResultText = "";
      setStatus("", false);
    }

    function setStatus(message, success) {
      statusText.textContent = message;
      statusText.classList.toggle("ok", Boolean(success));
    }

    async function copyResult() {
      if (!latestResultText) {
        setStatus("コピーできる結果がありません。", false);
        return;
      }
      try {
        await navigator.clipboard.writeText(latestResultText);
        setStatus("結果をコピーしました。", true);
      } catch (error) {
        setStatus("コピーに失敗しました。", false);
      }
    }

    async function copyPersonResult(index) {
      const text = latestPersonResultText[index];
      if (!text) {
        setStatus(index + "人目のコピーできる結果がありません。", false);
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        setStatus(index + "人目の結果をコピーしました。", true);
      } catch (error) {
        setStatus("コピーに失敗しました。", false);
      }
    }

    function getValue(id) {
      return document.getElementById(id).value.trim();
    }

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatDate(year, month, day) {
      return (
        String(year).padStart(4, "0") +
        "-" +
        String(month).padStart(2, "0") +
        "-" +
        String(day).padStart(2, "0")
      );
    }
  </script>
</body>
</html>
